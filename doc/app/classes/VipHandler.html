<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: VipHandler</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">VipHandler</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/lib/vip_handler_rb.html">
                lib/vip_handler.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000016">addXmlAttribute</a>&nbsp;&nbsp;
      <a href="#M000022">method_missing</a>&nbsp;&nbsp;
      <a href="#M000017">new</a>&nbsp;&nbsp;
      <a href="#M000019">on_characters</a>&nbsp;&nbsp;
      <a href="#M000020">on_end_document</a>&nbsp;&nbsp;
      <a href="#M000021">on_end_element_ns</a>&nbsp;&nbsp;
      <a href="#M000018">on_start_element_ns</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->
    <div id="includes">
      <h3 class="section-bar">Included Modules</h3>

      <div id="includes-list">
        <span class="include-name">LibXML::XML::SaxParser::Callbacks</span>
      </div>
    </div>

    <div id="section">


    <div id="constants-list">
      <h3 class="section-bar">Constants</h3>

      <div class="name-list">
        <table summary="Constants">
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">Debug</td>
          <td>=</td>
          <td class="context-item-value">20</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">Topelements</td>
          <td>=</td>
          <td class="context-item-value">[&quot;source&quot;,&quot;state&quot;,                        &quot;locality&quot;,&quot;precinct&quot;, &quot;election&quot;,                        &quot;precinct_split&quot;, &quot;election_administration&quot;,       #                        &quot;election_official&quot;, &quot;ballot_drop_location&quot;,       #                        &quot;contest&quot;,&quot;candidate&quot;,&quot;campaign_issue&quot;,   #                        &quot;campaign_statement&quot;,&quot;custom_ballot&quot;,     #                        &quot;custom_note&quot;,&quot;referendum&quot;,               #                        &quot;polling_location&quot;,&quot;street_segment&quot;,                        &quot;street_address&quot;, &quot;ballot&quot;,&quot;ballot_response&quot;,                        &quot;tabulation_area&quot;]</td>
          <td width="3em">&nbsp;</td>
          <td class="context-item-desc">
defines which top-level elements to parse

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">IdExceptions</td>
          <td>=</td>
          <td class="context-item-value">[&quot;vip_id&quot;, &quot;file_internal_id&quot;]</td>
          <td width="3em">&nbsp;</td>
          <td class="context-item-desc">
don&#8216;t try to map the following ID elements to objects

</td>
        </tr>
        </table>
      </div>
    </div>



      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000017" class="method-detail">
        <a name="M000017"></a>

        <div class="method-heading">
          <a href="#M000017" class="method-signature">
          <span class="method-name">new</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000017-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000017-source">
<pre>
     <span class="ruby-comment cmt"># File lib/vip_handler.rb, line 148</span>
148:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>()
149:                 <span class="ruby-comment cmt">#debug</span>
150:                 <span class="ruby-ivar">@resolved</span> = <span class="ruby-value">0</span>
151:                 <span class="ruby-ivar">@unresolved</span> = <span class="ruby-value">0</span>
152: 
153:                 <span class="ruby-comment cmt">#stack of xml attributes</span>
154:                 <span class="ruby-ivar">@stack</span>       = [];
155: 
156:                 <span class="ruby-comment cmt">#whether or not to save next set of characters</span>
157:                 <span class="ruby-ivar">@store_chars</span> = <span class="ruby-keyword kw">false</span>;
158: 
159:                 <span class="ruby-comment cmt">#source object used throughout</span>
160:                 <span class="ruby-ivar">@source</span>      = <span class="ruby-keyword kw">nil</span>
161:                 <span class="ruby-ivar">@source_id</span>   = <span class="ruby-keyword kw">nil</span>
162: 
163:                 <span class="ruby-comment cmt">#array to store id's not resolved from file_internal_id to database id's</span>
164:                 <span class="ruby-ivar">@unresolved_ids</span> = []
165: 
166: <span class="ruby-comment cmt">#               @contrib = contributor</span>
167: 
168:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000016" class="method-detail">
        <a name="M000016"></a>

        <div class="method-heading">
          <a href="#M000016" class="method-signature">
          <span class="method-name">addXmlAttribute</span><span class="method-args">(obj, attrib, val)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Takes attrib as the element from xml with val as it&#8216;s value. Assumes
that element name is the class attribute name, except in the case of
id&#8216;s.
</p>
<ul>
<li>Maps element&#8216;s ID to file_internal_id

</li>
<li>Overwrites IDs referenced by elements to database internal IDs

</li>
</ul>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000016-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000016-source">
<pre>
     <span class="ruby-comment cmt"># File lib/vip_handler.rb, line 33</span>
 33:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">addXmlAttribute</span>(<span class="ruby-identifier">obj</span>, <span class="ruby-identifier">attrib</span>, <span class="ruby-identifier">val</span>)
 34:                 <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">attrib</span>.<span class="ruby-identifier">eql?</span>(<span class="ruby-value str">&quot;id&quot;</span>))
 35:                         <span class="ruby-identifier">puts</span> <span class="ruby-identifier">attrib</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">4</span>
 36:                         <span class="ruby-identifier">innerattrib</span> = <span class="ruby-value str">&quot;file_internal_id&quot;</span>
 37:                 <span class="ruby-keyword kw">else</span>
 38:                         <span class="ruby-identifier">innerattrib</span> = <span class="ruby-identifier">attrib</span>
 39:                 <span class="ruby-keyword kw">end</span>
 40: 
 41:                 <span class="ruby-comment cmt"># store object if it exists</span>
 42:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">innerattrib</span>) <span class="ruby-keyword kw">or</span> 
 43:                    <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">innerattrib</span>[<span class="ruby-value">0</span>,<span class="ruby-identifier">innerattrib</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">3</span>].<span class="ruby-identifier">pluralize</span>) <span class="ruby-keyword kw">then</span>
 44: 
 45:                         <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">innerattrib</span>[<span class="ruby-value">-3</span>,<span class="ruby-value">3</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'_id'</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-constant">IdExceptions</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">innerattrib</span>))
 46:                                 <span class="ruby-comment cmt">#this is an ID in the file we need to map</span>
 47:                                 <span class="ruby-comment cmt">#to the database's internal ID</span>
 48: 
 49:                                 <span class="ruby-comment cmt">#grab attribute type from innerattrib (drop _id)</span>
 50:                                 <span class="ruby-identifier">attribute_type</span> = <span class="ruby-identifier">innerattrib</span>[<span class="ruby-value">0</span>,<span class="ruby-identifier">innerattrib</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">3</span>]
 51:                                 <span class="ruby-identifier">puts</span> <span class="ruby-identifier">attribute_type</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span>
 52: 
 53:                                 <span class="ruby-comment cmt">#drop start_ or end_ from attribute type of street address id's</span>
 54: <span class="ruby-comment cmt">#                               if (attribute_type.length &gt;= 14 &amp;&amp; attribute_type[-14,14] == 'street_address') then</span>
 55: <span class="ruby-comment cmt">#                                       attribute_type = 'street_address'</span>
 56: <span class="ruby-comment cmt">#                               end</span>
 57: <span class="ruby-comment cmt">#                               referenced_obj = attribute_type.camelcase.constantize.find(:first, </span>
 58: <span class="ruby-comment cmt">#                                                   :conditions =&gt; &quot;source_id = #{@source_id} AND file_internal_id = #{val}&quot;)</span>
 59:                         
 60:                                 <span class="ruby-identifier">attr_reflection</span> =   <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">reflect_on_association</span>(<span class="ruby-identifier">attribute_type</span>.<span class="ruby-identifier">to_sym</span>) 
 61:                                 <span class="ruby-identifier">attr_reflection</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">reflect_on_association</span>(<span class="ruby-identifier">attribute_type</span>.<span class="ruby-identifier">pluralize</span>.<span class="ruby-identifier">to_sym</span>)       
 62: 
 63:                                 <span class="ruby-identifier">attribute_class</span> = <span class="ruby-identifier">attr_reflection</span>.<span class="ruby-identifier">klass</span> 
 64:                                 <span class="ruby-identifier">referenced_obj</span> = <span class="ruby-ivar">@source_id</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">attribute_class</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, 
 65:                                                     <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;source_id = ? AND file_internal_id = ?&quot;</span>, 
 66:                                                                     <span class="ruby-ivar">@source_id</span>, <span class="ruby-identifier">val</span> ])
 67: 
 68:                                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">referenced_obj</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">then</span>
 69:                                         <span class="ruby-comment cmt"># we haven't found the referenced ID in the stack yet.</span>
 70:                                         <span class="ruby-comment cmt"># Add it to a table storing unresolved objects</span>
 71:                                         <span class="ruby-identifier">badone</span> = <span class="ruby-constant">UnresolvedId</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span>
 72:                                                 <span class="ruby-identifier">u</span>.<span class="ruby-identifier">source</span>       = <span class="ruby-ivar">@source</span>
 73:                                                 <span class="ruby-identifier">u</span>.<span class="ruby-identifier">object_class</span> = <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>
 74:                                                 <span class="ruby-identifier">u</span>.<span class="ruby-identifier">parameter</span>    = <span class="ruby-identifier">attrib</span>
 75:                                                 <span class="ruby-identifier">u</span>.<span class="ruby-identifier">val</span>          = <span class="ruby-identifier">val</span>
 76:                                         <span class="ruby-keyword kw">end</span>
 77: 
 78:                                         <span class="ruby-comment cmt"># save it to a stack.  We'll store it when the object gets an ID</span>
 79:                                         <span class="ruby-ivar">@unresolved_ids</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">badone</span>)
 80: 
 81:                                         <span class="ruby-identifier">puts</span> <span class="ruby-value str">'Added '</span><span class="ruby-operator">+</span><span class="ruby-identifier">innerattrib</span><span class="ruby-operator">+</span><span class="ruby-value str">' to resolution list.  Fail #'</span><span class="ruby-operator">+</span><span class="ruby-ivar">@unresolved</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span>
 82: 
 83:                                         <span class="ruby-comment cmt"># save file_internal_id in place of object id, unless it's HABTM</span>
 84:                                         <span class="ruby-identifier">obj</span>.[]=(<span class="ruby-identifier">innerattrib</span>,<span class="ruby-identifier">val</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">has_attribute?</span>(<span class="ruby-identifier">innerattrib</span>)
 85: 
 86:                                         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
 87: 
 88:                                 <span class="ruby-keyword kw">else</span> <span class="ruby-comment cmt">#referenced object is not nil</span>
 89:                                         <span class="ruby-comment cmt"># store object id</span>
 90:                                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">has_attribute?</span>(<span class="ruby-identifier">innerattrib</span>)
 91:                                                 <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Adding singular object &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">innerattrib</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">4</span>
 92:                                                 <span class="ruby-comment cmt">#not HABTM</span>
 93:                                                 <span class="ruby-identifier">obj</span>.[]=(<span class="ruby-identifier">innerattrib</span>,<span class="ruby-identifier">referenced_obj</span>.<span class="ruby-identifier">id</span>)
 94:                                         <span class="ruby-keyword kw">else</span>
 95:                                                 <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Adding plural object &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">innerattrib</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">4</span>
 96:                                                 <span class="ruby-comment cmt">#HABTM</span>
 97:                                               <span class="ruby-identifier">plural_attrib</span> = <span class="ruby-identifier">innerattrib</span>[<span class="ruby-value">0</span>,<span class="ruby-identifier">innerattrib</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">3</span>].<span class="ruby-identifier">pluralize</span>
 98:                                                 <span class="ruby-identifier">puts</span> <span class="ruby-identifier">plural_attrib</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">4</span>
 99: <span class="ruby-comment cmt">#                                               puts referenced_obj.inspect if Debug &gt; 4</span>
100:                                                 
101:                                                 <span class="ruby-identifier">puts</span> <span class="ruby-identifier">eval</span>(<span class="ruby-value str">'obj.'</span><span class="ruby-operator">+</span><span class="ruby-identifier">plural_attrib</span>).<span class="ruby-identifier">inspect</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">4</span>
102:                                                 
103:                                                 <span class="ruby-identifier">eval</span>(<span class="ruby-value str">'obj.'</span><span class="ruby-operator">+</span><span class="ruby-identifier">plural_attrib</span>).<span class="ruby-identifier">push</span> <span class="ruby-identifier">referenced_obj</span>
104: 
105: <span class="ruby-comment cmt">#                                               arr = eval('obj.'+plural_attrib) </span>
106: <span class="ruby-comment cmt">#                                               puts &quot;HABTM Size before: &quot;+(arr.nil? ? '0' : arr.size.to_s) if Debug &gt; 4</span>
107: <span class="ruby-comment cmt">#                                               arr ||= []</span>
108: <span class="ruby-comment cmt">#                                               arr &lt;&lt; referenced_obj</span>
109: <span class="ruby-comment cmt">#                                               puts obj.inspect</span>
110: <span class="ruby-comment cmt">#                                               puts arr.inspect</span>
111: <span class="ruby-comment cmt">#                                               puts &quot;HABTM Size after:  &quot;+arr.size.to_s if Debug &gt; 4</span>
112: <span class="ruby-comment cmt">#                                               obj.[]=(plural_attrib,arr) </span>
113: <span class="ruby-comment cmt">#                                               arr = obj.[](plural_attrib) </span>
114: <span class="ruby-comment cmt">#                                               puts &quot;HABTM Size saved: &quot;+(arr.nil? ? '0' : arr.size.to_s) if Debug &gt; 4</span>
115: <span class="ruby-comment cmt">#                                               obj.save</span>
116:                                         <span class="ruby-keyword kw">end</span>
117: 
118:                                         <span class="ruby-identifier">puts</span> <span class="ruby-value str">'Set '</span><span class="ruby-operator">+</span><span class="ruby-identifier">innerattrib</span><span class="ruby-operator">+</span><span class="ruby-value str">' to valid object.  Success #'</span><span class="ruby-operator">+</span><span class="ruby-ivar">@resolved</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span>
119:                                         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
120: 
121:                                 <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt">#if referenced_obj.nil?</span>
122:                                         
123: <span class="ruby-comment cmt">#                       elsif (innerattrib.eql?('file_internal_id')) then</span>
124: <span class="ruby-comment cmt">#                               #make sure we store a string and not an object</span>
125: <span class="ruby-comment cmt">#                               obj.[]=(innerattrib,val.to_i)</span>
126: <span class="ruby-comment cmt">#                               puts 'Set '+innerattrib+' to '+val.to_s if Debug &gt; 3</span>
127: 
128:                         <span class="ruby-keyword kw">else</span> <span class="ruby-comment cmt">#just a normal attribute, not an object reference</span>
129: 
130:                                 <span class="ruby-comment cmt">#TODO: Make DRY</span>
131:                                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">has_attribute?</span>(<span class="ruby-identifier">innerattrib</span>)
132:                                         <span class="ruby-comment cmt">#not HABTM</span>
133:                                         <span class="ruby-identifier">obj</span>.[]=(<span class="ruby-identifier">innerattrib</span>,<span class="ruby-identifier">val</span>)
134:                                 <span class="ruby-keyword kw">else</span>
135:                                         <span class="ruby-comment cmt">#HABTM</span>
136:                                        <span class="ruby-identifier">plural_attrib</span> = <span class="ruby-identifier">innerattrib</span>[<span class="ruby-value">0</span>,<span class="ruby-identifier">innerattrib</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">3</span>].<span class="ruby-identifier">pluralize</span>
137:                                         <span class="ruby-identifier">obj</span>.[](<span class="ruby-identifier">plural_attrib</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">val</span> 
138:                                 <span class="ruby-keyword kw">end</span>
139:                                 <span class="ruby-identifier">puts</span> <span class="ruby-value str">'Set '</span><span class="ruby-operator">+</span><span class="ruby-identifier">innerattrib</span><span class="ruby-operator">+</span><span class="ruby-value str">' to '</span><span class="ruby-operator">+</span><span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">5</span>
140:                                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
141:                         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt">#id check</span>
142:                 <span class="ruby-keyword kw">else</span>
143:                         <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Ignored &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">attrib</span><span class="ruby-operator">+</span><span class="ruby-value str">&quot; in &quot;</span> <span class="ruby-operator">+</span><span class="ruby-identifier">obj</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
144:                 <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt">#attribute existence check</span>
145: 
146:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000022" class="method-detail">
        <a name="M000022"></a>

        <div class="method-heading">
          <a href="#M000022" class="method-signature">
          <span class="method-name">method_missing</span><span class="method-args">(method_name, *attributes, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000022-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000022-source">
<pre>
     <span class="ruby-comment cmt"># File lib/vip_handler.rb, line 343</span>
343:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">method_missing</span>(<span class="ruby-identifier">method_name</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">attributes</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
344:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000019" class="method-detail">
        <a name="M000019"></a>

        <div class="method-heading">
          <a href="#M000019" class="method-signature">
          <span class="method-name">on_characters</span><span class="method-args">(chars)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000019-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000019-source">
<pre>
     <span class="ruby-comment cmt"># File lib/vip_handler.rb, line 245</span>
245:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">on_characters</span>(<span class="ruby-identifier">chars</span>)
246:                 <span class="ruby-keyword kw">if</span> (<span class="ruby-ivar">@store_chars</span>) <span class="ruby-keyword kw">then</span>
247:                         <span class="ruby-identifier">buffer</span> = <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">pop</span>
248: <span class="ruby-comment cmt">#                       buffer = @stack.last</span>
249:                         <span class="ruby-identifier">buffer</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">chars</span>
250:                         <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">buffer</span>)
251:                 <span class="ruby-keyword kw">end</span>
252:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000020" class="method-detail">
        <a name="M000020"></a>

        <div class="method-heading">
          <a href="#M000020" class="method-signature">
          <span class="method-name">on_end_document</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000020-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000020-source">
<pre>
     <span class="ruby-comment cmt"># File lib/vip_handler.rb, line 254</span>
254:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">on_end_document</span>()
255:                 <span class="ruby-comment cmt">#resolve IDs.  Might add internal_file_id to unresolved_ids record as a check</span>
256:                 <span class="ruby-identifier">unresolved_ids</span> = <span class="ruby-ivar">@source</span>.<span class="ruby-identifier">unresolved_ids</span>
257: <span class="ruby-comment cmt">#               puts unresolved_ids.size if Debug &gt; 1</span>
258: 
259:                 <span class="ruby-identifier">puts</span> <span class="ruby-ivar">@unresolved_ids</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; unresolved IDs&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span>
260: 
261:                 <span class="ruby-identifier">unresolved_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span>
262:                         <span class="ruby-identifier">obj</span> = <span class="ruby-identifier">u</span>.<span class="ruby-identifier">object_class</span>.<span class="ruby-identifier">constantize</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">u</span>.<span class="ruby-identifier">object_id</span>)     
263:                         <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">addXmlAttribute</span>(<span class="ruby-identifier">obj</span>,<span class="ruby-identifier">u</span>.<span class="ruby-identifier">parameter</span>,<span class="ruby-identifier">u</span>.<span class="ruby-identifier">val</span>)) <span class="ruby-keyword kw">then</span>     
264:                                 <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Resolved&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span>
265:                                 <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">save</span>
266:                                 <span class="ruby-identifier">u</span>.<span class="ruby-identifier">destroy</span>
267:                         <span class="ruby-keyword kw">end</span>
268:                 <span class="ruby-keyword kw">end</span>
269: 
270:                 <span class="ruby-identifier">puts</span> <span class="ruby-ivar">@unresolved_ids</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; unresolved IDs&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span>
271: 
272:                 <span class="ruby-comment cmt"># add state_id to streets.  these eases later lookup</span>
273:                 <span class="ruby-identifier">addresses</span> = <span class="ruby-ivar">@source</span>.<span class="ruby-identifier">street_addresses</span>
274:                 <span class="ruby-identifier">addresses</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">addr</span><span class="ruby-operator">|</span>
275:                         <span class="ruby-identifier">addr</span>.<span class="ruby-identifier">state</span> = <span class="ruby-identifier">addr</span>.<span class="ruby-identifier">street_segments</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">precinct</span>.<span class="ruby-identifier">locality</span>.<span class="ruby-identifier">state</span>
276:                         <span class="ruby-identifier">addr</span>.<span class="ruby-identifier">save</span>
277:                 <span class="ruby-keyword kw">end</span>
278: 
279:                 <span class="ruby-ivar">@source</span>.<span class="ruby-identifier">import_completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
280:                 <span class="ruby-ivar">@source</span>.<span class="ruby-identifier">save</span>
281: 
282:                 <span class="ruby-comment cmt"># MySQL specific one-liner</span>
283: <span class="ruby-comment cmt">#               @source.connection.execute(&quot;UPDATE street_addresses sa, </span>
284: <span class="ruby-comment cmt">#                                                   street_segments ss, </span>
285: <span class="ruby-comment cmt">#                                                   precincts p, </span>
286: <span class="ruby-comment cmt">#                                                   localities l </span>
287: <span class="ruby-comment cmt">#                                            SET    sa.state_id = l.state_id</span>
288: <span class="ruby-comment cmt">#                                           WHERE  sa.id IN (ss.start_street_address_id, ss.end_street_address_id)</span>
289: <span class="ruby-comment cmt">#                                             AND  ss.precinct_id = p.id</span>
290: <span class="ruby-comment cmt">#                                             AND  p.locality_id = l.id</span>
291: <span class="ruby-comment cmt">#                                             AND  sa.source_id = #{@source.id}&quot;)</span>
292: 
293:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000021" class="method-detail">
        <a name="M000021"></a>

        <div class="method-heading">
          <a href="#M000021" class="method-signature">
          <span class="method-name">on_end_element_ns</span><span class="method-args">(element, prefix, uri)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000021-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000021-source">
<pre>
     <span class="ruby-comment cmt"># File lib/vip_handler.rb, line 295</span>
295:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">on_end_element_ns</span>(<span class="ruby-identifier">element</span>, <span class="ruby-identifier">prefix</span>, <span class="ruby-identifier">uri</span>)
296: 
297:                 <span class="ruby-keyword kw">if</span> (<span class="ruby-ivar">@store_chars</span>) <span class="ruby-keyword kw">then</span>
298:                         <span class="ruby-identifier">chars</span>   = <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">pop</span>
299:                         <span class="ruby-identifier">element</span> = <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">pop</span>
300:                         <span class="ruby-identifier">obj</span>     = <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">last</span>
301:                         <span class="ruby-identifier">addXmlAttribute</span>(<span class="ruby-identifier">obj</span>,<span class="ruby-identifier">element</span>,<span class="ruby-identifier">chars</span>)
302:                         <span class="ruby-ivar">@store_chars</span> = <span class="ruby-keyword kw">false</span>;
303:                 <span class="ruby-keyword kw">else</span>
304:                         <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;End &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">element</span><span class="ruby-operator">+</span><span class="ruby-value str">&quot; \n &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span><span class="ruby-operator">&gt;</span><span class="ruby-value">2</span>
305: <span class="ruby-comment cmt">#                       if [&quot;source&quot;, &quot;precinct&quot;].include?(element.downcase) then</span>
306:                         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-keyword kw">then</span>
307:                                 <span class="ruby-identifier">obj</span> = <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">pop</span>
308: <span class="ruby-comment cmt">#                               if element == 'street_address' then</span>
309: <span class="ruby-comment cmt">#                                       obj.connection.execute (&quot;INSERT INTO street_addresses SET </span>
310: <span class="ruby-comment cmt">#                                                    source_id = #{obj.source.id},</span>
311: <span class="ruby-comment cmt">#                                                   file_internal_id = #{obj.file_internal_id},</span>
312: <span class="ruby-comment cmt">#                                                   house_number = #{obj.house_number}, </span>
313: <span class="ruby-comment cmt">#                                                   street_direction = #{obj.street_direction} ,</span>
314: <span class="ruby-comment cmt">#                                                   street_name = #{obj.street_name}, </span>
315: <span class="ruby-comment cmt">#                                                   street_suffix = #{obj.street_suffix}, </span>
316: <span class="ruby-comment cmt">#                                                   address_direction = #{obj.address_direction}, </span>
317: <span class="ruby-comment cmt">#                                                   apartment = #{obj.apartment}, </span>
318: <span class="ruby-comment cmt">#                                                   city = #{obj.city}, </span>
319: <span class="ruby-comment cmt">#                                                   zip = #{obj.zip}&quot;)</span>
320: <span class="ruby-comment cmt">#                               else</span>
321:                                         <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">save</span>(<span class="ruby-keyword kw">false</span>)) <span class="ruby-keyword kw">then</span>
322:                                                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">element</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'source'</span> <span class="ruby-keyword kw">then</span>
323:                                                         <span class="ruby-ivar">@source_id</span> = <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">id</span>
324:                                                 <span class="ruby-keyword kw">end</span>
325: <span class="ruby-comment cmt">#                                               puts &quot;Saving #{element} with #{@unresolved_ids.size} unresolved ids&quot;</span>
326:                                                 <span class="ruby-constant">UnresolvedId</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword kw">do</span>
327:                                                         <span class="ruby-ivar">@unresolved_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span>
328:                                                                 <span class="ruby-identifier">u</span>.<span class="ruby-identifier">object_id</span> = <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">id</span>
329:                                                                 <span class="ruby-identifier">u</span>.<span class="ruby-identifier">save</span>(<span class="ruby-keyword kw">false</span>)
330:                                                         <span class="ruby-keyword kw">end</span>
331:                                                      <span class="ruby-ivar">@unresolved_ids</span> = []
332:                                                 <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt">#transaction</span>
333:                                                 <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;file_internal_id: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">file_internal_id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span>
334:                                                 <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;saved&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">4</span>
335:                                         <span class="ruby-keyword kw">else</span>
336:                                                 <span class="ruby-identifier">puts</span> <span class="ruby-identifier">element</span> <span class="ruby-operator">+</span> <span class="ruby-value str">' not saved.  Id: '</span><span class="ruby-operator">+</span><span class="ruby-identifier">obj</span>.<span class="ruby-identifier">file_internal_id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span>
337:                                         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt">#if obj.save</span>
338: <span class="ruby-comment cmt">#                               end #element == street_address</span>
339:                         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt">#stack.size == 1</span>
340:                 <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt">#store_chars</span>
341:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000018" class="method-detail">
        <a name="M000018"></a>

        <div class="method-heading">
          <a href="#M000018" class="method-signature">
          <span class="method-name">on_start_element_ns</span><span class="method-args">(element, attributes, prefix, uri, namespaces)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000018-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000018-source">
<pre>
     <span class="ruby-comment cmt"># File lib/vip_handler.rb, line 170</span>
170:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">on_start_element_ns</span>(<span class="ruby-identifier">element</span>, <span class="ruby-identifier">attributes</span>, <span class="ruby-identifier">prefix</span>, <span class="ruby-identifier">uri</span>, <span class="ruby-identifier">namespaces</span>)
171:                 <span class="ruby-identifier">element</span>.<span class="ruby-identifier">downcase!</span>
172:                 <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Start &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">element</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>
173: 
174:                 <span class="ruby-comment cmt"># NOTE: This parsing relies on the simple two-level structure </span>
175:                 <span class="ruby-comment cmt"># of VIP data.</span>
176:                 <span class="ruby-keyword kw">if</span> (<span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Topelements</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">element</span>)) <span class="ruby-keyword kw">then</span>
177:                    <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">element</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'source'</span>
178:                       <span class="ruby-identifier">obj</span> = <span class="ruby-constant">Source</span>.<span class="ruby-identifier">new</span>
179:                       <span class="ruby-ivar">@source</span> = <span class="ruby-identifier">obj</span>
180:                    <span class="ruby-keyword kw">else</span>
181:                       <span class="ruby-identifier">raise</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@source</span>.<span class="ruby-identifier">nil?</span>
182:                       <span class="ruby-identifier">obj</span> = <span class="ruby-identifier">element</span>.<span class="ruby-identifier">camelcase</span>.<span class="ruby-identifier">constantize</span>.<span class="ruby-identifier">new</span>
183:                       <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">source</span> = <span class="ruby-ivar">@source</span>
184:                    <span class="ruby-keyword kw">end</span>
185: 
186:                    <span class="ruby-comment cmt">#store attributes inside start tag</span>
187:                    <span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> 
188:                            <span class="ruby-identifier">puts</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">4</span>
189:                            <span class="ruby-identifier">addXmlAttribute</span>(<span class="ruby-identifier">obj</span>,<span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span>)
190:                    }
191:                    <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">obj</span>)
192: 
193: <span class="ruby-comment cmt">#TODO: optimize insertions</span>
194: ??
195: 
196:                 <span class="ruby-keyword kw">elsif</span> (<span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword kw">then</span> <span class="ruby-comment cmt"># &amp;&amp; Innerelements.include?(element)) then</span>
197:                            <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">push</span>(<span class="ruby-constant">String</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">element</span>))
198:                            <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">push</span>(<span class="ruby-constant">String</span>.<span class="ruby-identifier">new</span>())
199:                            <span class="ruby-ivar">@store_chars</span> = <span class="ruby-keyword kw">true</span>
200:                 <span class="ruby-keyword kw">else</span>
201:                         <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Ignoring element: &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">element</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Debug</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
202:                 <span class="ruby-keyword kw">end</span>
203: 
204:         <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>